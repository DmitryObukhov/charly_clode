# Charly - Neuromorphic Simulation Framework

**Version 0.3** - Orgasm/Terror Physical Model

Charly is a neuromorphic cellular automaton simulation that tests whether a neural substrate can learn to react appropriately to a physical model of reality.

## Quick Start

```batch
# Live visualization mode (recommended)
cd src
python main.py --live

# Batch mode
run.bat 5              # Run simulation for 5 days
run.bat 10 results     # Run 10 days, output to results/
```

## Project Structure

```
charly/
├── run.bat             # Run the simulation
├── build.bat           # Rebuild sources using Claude Code
├── config/
│   └── config.yaml     # Simulation configuration
├── src/
│   ├── physical_model.py   # Abstract base class
│   ├── model_linear.py     # Linear 1D world
│   ├── charly.py           # Neural substrate
│   └── main.py             # CLI application
├── devlogs/            # Conversation exports
├── CLAUDE.md           # Claude Code guide
├── physics.md          # Physical model spec
├── neuron.md           # Neuron structure spec
├── substrate.md        # Substrate spec
├── sequence.md         # SequenceGenerator DSL
└── application.md      # CLI application spec
```

## Batch Files

### run.bat
Runs the simulation with specified parameters:
```batch
run.bat [days] [output_dir]
```
- `days`: Number of simulation days (default: 1)
- `output_dir`: Output directory (default: output)

### build.bat
Invokes Claude Code to regenerate all source files from prompt specifications:
```batch
build.bat
```
- Cleans `src/` directory
- Preserves `config/` files
- Regenerates code from `*.md` prompt files

## Development

The project uses a prompt-driven development approach:
1. Specifications are defined in `.md` prompt files
2. Source code is generated by Claude Code based on prompts
3. `build.bat` regenerates sources when prompts change

### Prompt Files
| File | Specifies |
|------|-----------|
| `physics.md` | PhysicalModel interface, Linear world, formulas |
| `neuron.md` | Neuron structure, `_process_neuron()` algorithm |
| `substrate.md` | Charly class, connectome, day/night cycles |
| `application.md` | CLI usage, execution flow |
| `sequence.md` | SequenceGenerator DSL |

## Checkpoints

### v0.3 - Orgasm/Terror Physical Model (Current)
New physical model where agent tracks a moving lamp with pleasure/pain feedback.

Features:
- **Lamp Movement**: Configurable sine, linear, or file-based (e.g., stock prices)
- **Orgasm Signal**: Reward when agent matches lamp position (within tolerance)
- **Terror Signals**: Punishment for deviation (terror_up/terror_down)
- **Smoothness Control**: Response curve shape (0%=binary, 50%=sigmoid, 100%=linear)
- **New Actuators**: move_up/move_down for agent control

Neuron Layout (5000):
- Head 0-99: Reserved
- Head 100-399: Terror Up (agent above lamp)
- Head 400-699: Terror Down (agent below lamp)
- Head 700-999: Orgasm (matching lamp)
- Tail 4000-4399: Move Up actuator
- Tail 4500-4899: Move Down actuator

### v0.2 - Live Visualization
Real-time monitoring of neural activity with scrolling display.

Features:
- **Live Mode** (`--live` flag): Opens 1920x1080 window with real-time visualization
- **Scrolling Display**: Shows last 1080 iterations, scrolls when buffer fills
- **CES Bar Chart**: ESP (green) extends right from center, ESN (red) extends left
- **Configurable CES Range**: `CES_RANGE` parameter (default: +/- 5000)
- **Info Overlay**: Step count and timestamp in lower left corner
- **Keyboard Controls**: `q` to quit, `s` to save frame
- **Window Close Detection**: X button properly stops simulation

Configuration:
- Reduced to 5000 neurons for faster iteration
- 20000 steps per day for longer simulations
- All neuron indices proportionally scaled

### v0.1 - Elastic Control Proof of Concept
**Key Finding**: Elastic control via Sauron's Finger can modulate CES (Cumulative Emotional State).

Features:
- **Connectome Distribution**: Configurable link length distribution per neuron segment
  - 3-band system: short/mid/long links with percentage allocation
  - "Zebra" pattern support: alternating local (80-15-5) and distant (5-15-80) connectivity
- **Sauron's Finger v2**: Formula-based dynamic substrate modification
  - Executable formulas with macros: IDX, X, R, DIST, PREV, SHAPE, TEMPORAL, ROW
  - Radial shape formulas (gaussian, custom)
  - Temporal row windows with pressure distribution
- **Actuator System**: Redesigned with EQ assignment and visualization
  - Format: name, start, count, default_eq, color
  - Actuator strip visualization with per-actuator colors
  - TAIL_COUNT parameter for motor region
- **Visualization Enhancements**:
  - Unscaled ESP/ESN strip overlay
  - Actuator output strip with configurable width
  - White 1px separators between body/actuator/CES strips
  - Dark grey background for head and actuator neurons

### Population Coding & Visualization
- **Population-coded inputs**: Eye sensor spreads luminosity across neurons using Stevens' power law
- **Thermometer coding**: Low luminosity activates few neurons, high luminosity activates many
- **CES waveform display**: ESP (light green) and ESN (red) as waveform dots with grid
- **Inactive head neurons**: Displayed as dark grey in visualization
- **Linear lamp movement**: Lamp moves left-to-right once per day
- **Physical model visualization**: Generates `physical_*.png` showing agent/lamp positions

### Source Generation
Generated implementation in `src/` based on prompt specifications.

### Combined the Prompts
Initial checkpoint consolidating specifications from original `main_prompt.txt` into modular prompt files.

# Charly - Neuromorphic Simulation Framework

**Version 0.5** - HTTP Server Mode

Charly is a neuromorphic cellular automaton simulation that tests whether a neural substrate can learn to react appropriately to a physical model of reality.

## Quick Start

```batch
cd src

# Server mode (recommended) - web-based control with live visualization
python main.py --serve --name mysim --config ../config/config.yaml
# Then open http://localhost:8000 in browser

# Arc visualization - connectome as horizontal chain with arcs
python main.py --arc

# Live visualization - scrolling neural activity heatmap
python main.py --live

# Batch mode - run multiple days with video output
python main.py --days 5 --output results
```

### Interactive Controls (Arc & Live modes)

| Key | Action |
|-----|--------|
| `1` | Trigger Finger (elastic_trigger) |
| `2` | EQ Finger (emotional quantum) |
| `3` | Fatigue Finger |
| `4` | Charge Finger |
| LMB | Apply positive effect |
| RMB | Apply negative effect |
| `q` | Quit |
| `s` | Save frame |

## Project Structure

```
charly/
├── run.bat             # Run the simulation
├── build.bat           # Rebuild sources using Claude Code
├── config/
│   └── config.yaml     # Simulation configuration
├── src/
│   ├── physical_model.py   # Abstract base class
│   ├── model_linear.py     # Linear 1D world
│   ├── charly.py           # Neural substrate
│   ├── server.py           # HTTP server mode
│   └── main.py             # CLI application
├── devlogs/            # Conversation exports
├── CLAUDE.md           # Claude Code guide
├── physics.md          # Physical model spec
├── neuron.md           # Neuron structure spec
├── substrate.md        # Substrate spec
├── sequence.md         # SequenceGenerator DSL
└── application.md      # CLI application spec
```

## Batch Files

### run.bat
Runs the simulation with specified parameters:
```batch
run.bat [days] [output_dir]
```
- `days`: Number of simulation days (default: 1)
- `output_dir`: Output directory (default: output)

### build.bat
Invokes Claude Code to regenerate all source files from prompt specifications:
```batch
build.bat
```
- Cleans `src/` directory
- Preserves `config/` files
- Regenerates code from `*.md` prompt files

## Development

The project uses a prompt-driven development approach:
1. Specifications are defined in `.md` prompt files
2. Source code is generated by Claude Code based on prompts
3. `build.bat` regenerates sources when prompts change

### Prompt Files
| File | Specifies |
|------|-----------|
| `physics.md` | PhysicalModel interface, Linear world, formulas |
| `neuron.md` | Neuron structure, `_process_neuron()` algorithm |
| `substrate.md` | Charly class, connectome, day/night cycles |
| `application.md` | CLI usage, execution flow |
| `sequence.md` | SequenceGenerator DSL |

## Checkpoints

### v0.5 - HTTP Server Mode (Current)

Web-based control and monitoring with persistent state.

**Server Mode** (`--serve`):
- HTTP server with web UI at `http://localhost:<port>/`
- Controls: Start, Pause, Stop, Step (+1, +10, +100, +1000)
- Real-time metrics: iteration, day, ESP/ESN, agent/lamp positions
- Neuron activity matrix visualization (all neurons as pixels)
- Activation history coloring (bright=current, dim=previous steps)

**State Persistence**:
- Simulations stored in `simulations/<name>/` directory
- JSON serialization of neurons, connectome, RNG state
- Resume from saved state: `--serve --name mysim` (no config needed)
- Auto-save every 1000 iterations

**Usage**:
```batch
# New simulation
python main.py --serve --name mysim --config ../config/config.yaml

# Resume existing
python main.py --serve --name mysim

# Specify port
python main.py --serve --name mysim --port 8080
```

### v0.4 - Arc Visualization & Multi-Finger Control

New visualization mode and expanded Sauron's Finger system.

**Arc Visualization** (`--arc`):
- Neurons displayed as horizontal chain
- Active connections shown as arcs (green up = +EQ, red down = -EQ)
- Arc brightness = weight × recency (fades over 128 cycles)
- Frame averaging over 4 steps for smooth display
- Auto-saves all frames as PNG, compiles to MP4 on exit

**Multi-Finger System**:
| Finger | Field | Positive (+) | Negative (-) |
|--------|-------|--------------|--------------|
| Trigger | `elastic_trigger` | Easier to fire | Harder to fire |
| EQ | `eq` | +pleasure | +pain |
| Fatigue | `fatigue` | Hyperactive | Exhausted |
| Charge | `charge` | Inject charge | Drain charge |

**Connectome Improvements**:
- `LINK_LENGTH_MAX`: 500 → 1000 (reaches all head zones)
- Banded distributions reaching terror (100-399) and orgasm (700-999)
- Segment 1000-1500: [30, 30, 40] - heavy long-range to head

**Documentation Updates**:
- Fatigue system fully documented in `neuron.md`
- All finger types documented in `substrate.md`
- Interactive controls documented

### v0.3 - Orgasm/Terror Physical Model
New physical model where agent tracks a moving lamp with pleasure/pain feedback.

Features:
- **Lamp Movement**: Configurable sine, linear, or file-based (e.g., stock prices)
- **Orgasm Signal**: Reward when agent matches lamp position (within tolerance)
- **Terror Signals**: Punishment for deviation (terror_up/terror_down)
- **Smoothness Control**: Response curve shape (0%=binary, 50%=sigmoid, 100%=linear)
- **New Actuators**: move_up/move_down for agent control

Neuron Layout (5000):
- Head 0-99: Reserved
- Head 100-399: Terror Up (agent above lamp)
- Head 400-699: Terror Down (agent below lamp)
- Head 700-999: Orgasm (matching lamp)
- Tail 4000-4399: Move Up actuator
- Tail 4500-4899: Move Down actuator

### v0.2 - Live Visualization
Real-time monitoring of neural activity with scrolling display.

Features:
- **Live Mode** (`--live` flag): Opens 1920x1080 window with real-time visualization
- **Scrolling Display**: Shows last 1080 iterations, scrolls when buffer fills
- **CES Bar Chart**: ESP (green) extends right from center, ESN (red) extends left
- **Configurable CES Range**: `CES_RANGE` parameter (default: +/- 5000)
- **Info Overlay**: Step count and timestamp in lower left corner
- **Keyboard Controls**: `q` to quit, `s` to save frame
- **Window Close Detection**: X button properly stops simulation

Configuration:
- Reduced to 5000 neurons for faster iteration
- 20000 steps per day for longer simulations
- All neuron indices proportionally scaled

### v0.1 - Elastic Control Proof of Concept
**Key Finding**: Elastic control via Sauron's Finger can modulate CES (Cumulative Emotional State).

Features:
- **Connectome Distribution**: Configurable link length distribution per neuron segment
  - 3-band system: short/mid/long links with percentage allocation
  - "Zebra" pattern support: alternating local (80-15-5) and distant (5-15-80) connectivity
- **Sauron's Finger v2**: Formula-based dynamic substrate modification
  - Executable formulas with macros: IDX, X, R, DIST, PREV, SHAPE, TEMPORAL, ROW
  - Radial shape formulas (gaussian, custom)
  - Temporal row windows with pressure distribution
- **Actuator System**: Redesigned with EQ assignment and visualization
  - Format: name, start, count, default_eq, color
  - Actuator strip visualization with per-actuator colors
  - TAIL_COUNT parameter for motor region
- **Visualization Enhancements**:
  - Unscaled ESP/ESN strip overlay
  - Actuator output strip with configurable width
  - White 1px separators between body/actuator/CES strips
  - Dark grey background for head and actuator neurons

### Population Coding & Visualization
- **Population-coded inputs**: Eye sensor spreads luminosity across neurons using Stevens' power law
- **Thermometer coding**: Low luminosity activates few neurons, high luminosity activates many
- **CES waveform display**: ESP (light green) and ESN (red) as waveform dots with grid
- **Inactive head neurons**: Displayed as dark grey in visualization
- **Linear lamp movement**: Lamp moves left-to-right once per day
- **Physical model visualization**: Generates `physical_*.png` showing agent/lamp positions

### Source Generation
Generated implementation in `src/` based on prompt specifications.

### Combined the Prompts


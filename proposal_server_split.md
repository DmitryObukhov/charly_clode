# Предложение: Разделение архитектуры Charly на Server/Client

## Концепция
Разделение монолитного приложения на сервер симуляции (Charly Node) и клиенты визуализации/управления. Это позволит:
1. Запускать тяжелую симуляцию на выделенном сервере.
2. Подключать разные визуализаторы ("Arc", "Scroll", "3D") к одному процессу.
3. Организовать "машину времени" — перезапуск с любого момента истории.

## Сервер (Charly Node)

Сервер представляет собой инстанс Charly, живущий в своем физическом мире.

### Запуск и Окружение
Сервер запускается в указанной **рабочей директории**, которая является уникальным хранилищем данных жизни этого экземпляра.

```bash
python charly_server.py --workdir ./instances/run_001 --config ./config.yaml --port 8000
```

### Структура Рабочей Директории
```
run_001/
├── config.yaml          # Копия конфига, с которым стартовали
├── state.json           # Текущее состояние (step, scores)
├── history/             # История жизни (бинарные чанки или БД)
│   ├── chunk_0000.bin
│   └── chunk_0001.bin
├── logs/                # Логи работы
└── checkpoints/         # Полные слепки памяти для перезапуска
    └── step_0001000.dump
```

### Функционал Сервера
1. **Симуляция**: Крутит цикл Day/Night и физическую модель.
2. **Персистентность**: Пишет каждое состояние на диск. Позволяет загрузиться с любого `step_id`.
3. **HTTP API**: Предоставляет REST интерфейс для взаимодействия.
4. **Default UI**: Отдает статический HTML/JS для базового мониторинга по адресу `/`.

## JSON REST API

### Управление и Статус
*   `GET /api/status` — Текущий шаг, статус (running/paused), параметры мира.
*   `GET /api/config` — Полный конфиг симуляции.
*   `POST /api/control/step` — Выполнить N шагов (если на паузе).
*   `POST /api/control/restart` — Перезапустить с шага X (требует наличия истории/чекпоинта).

### Данные (Read)
*   `GET /api/visual/state` — Возвращает агрегированные данные для визуализации (последние H шагов).
    *   *Response*: `{width: 1920, height: 1080, format: "raw_bgr", data: "<base64>"}`
*   `GET /api/neuron/range/{start}/{end}` — Возвращает состояние нейронов в диапазоне [start, end).
    *   *Response*: `[{id, eq, charge, active, fatigue, ...}, ...]`
*   `GET /api/synapse/inputs/{neuron_id}` — Список входящих синапсов.
*   `GET /api/synapse/outputs/{neuron_id}` — Список исходящих синапсов.

### Управление (Write)
*   `POST /api/neuron/{id}/modify` — Изменить параметры нейрона (Sauron's Finger).
    *   *Body*: `{field: "charge", value: 100, operation: "add"}`
*   `POST /api/synapse/modify` — Изменить веса или создать связь.

## Реализация Default View (Web)

По адресу `http://localhost:8000/` сервер отдает веб-страницу.
**Функционал:**
*   Отображение "Rolling Bitmap" (последние `DEFAULT_HEIGHT` шагов) через Canvas.
*   Картинка обновляется через периодический поллинг или WebSocket.
*   Базовые кнопки: Pause, Resume, Step, Restart.

## Этапы реализации
1.  **Phase 1**: Создание `charly_server.py` на базе `FastAPI` или `Flask`. Реализация цикла симуляции в отдельном потоке.
2.  **Phase 2**: Реализация API чтения состояния (`/visual/state`, `/neuron`).
3.  **Phase 3**: Механизм сохранения истории и перезапуска (`checkpoints`).
4.  **Phase 4**: Создание веб-клиента (HTML/JS) для дефолтного просмотра.
